name: Testes de Aceita√ß√£o

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_run:
        workflows: ["Testes Automatizados"]
        types:
            - completed

permissions:
    contents: read
    checks: write
    pull-requests: write

jobs:
    acceptance-tests:
        name: Testes de Aceita√ß√£o
        runs-on: ubuntu-latest

        # S√≥ executa se os testes automatizados passaram
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' || github.event_name == 'pull_request' }}

        steps:
            - name: Checkout do c√≥digo
              uses: actions/checkout@v4

            - name: Configurar Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Instalar depend√™ncias
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Criar diret√≥rios para resultados
              run: |
                  mkdir -p test-results
                  mkdir -p test-screenshots
                  mkdir -p test-videos

            - name: Iniciar aplica√ß√£o em background
              run: |
                  echo "Iniciando aplica√ß√£o da loja online..."
                  nohup python -m src.loja_online.main > app.log 2>&1 &
                  APP_PID=$!
                  echo "APP_PID=$APP_PID" >> $GITHUB_ENV
                  echo "Aplica√ß√£o iniciada com PID: $APP_PID"

            - name: Aguardar aplica√ß√£o estar pronta
              run: |
                  echo "Aguardando aplica√ß√£o inicializar..."
                  sleep 3
                  echo "Aplica√ß√£o pronta para testes"

            - name: Executar Testes de Aceita√ß√£o Funcionais
              id: functional_tests
              run: |
                  echo "=========================================="
                  echo "EXECUTANDO TESTES DE ACEITA√á√ÉO FUNCIONAIS"
                  echo "=========================================="
                  pytest tests/acceptance/test_fluxo_completo_loja.py -v -s --tb=long --junit-xml=test-results/acceptance-functional.xml
              continue-on-error: true

            - name: Executar Testes de Performance
              id: performance_tests
              run: |
                  echo "=========================================="
                  echo "EXECUTANDO TESTES DE PERFORMANCE"
                  echo "=========================================="
                  pytest tests/acceptance/test_performance.py -v -s --tb=long --junit-xml=test-results/acceptance-performance.xml
              continue-on-error: true

            - name: Capturar logs da aplica√ß√£o em caso de falha
              if: failure()
              run: |
                  echo "=========================================="
                  echo "CAPTURANDO LOGS DA APLICA√á√ÉO"
                  echo "=========================================="
                  if [ -f app.log ]; then
                    echo "Logs da aplica√ß√£o:"
                    cat app.log
                    cp app.log test-results/app-failure.log
                  else
                    echo "Arquivo de log n√£o encontrado"
                  fi

            - name: Capturar estado do sistema em caso de falha
              if: failure()
              run: |
                  echo "=========================================="
                  echo "CAPTURANDO ESTADO DO SISTEMA"
                  echo "=========================================="
                  echo "Processos Python em execu√ß√£o:"
                  ps aux | grep python || true
                  echo ""
                  echo "Uso de mem√≥ria:"
                  free -h || true
                  echo ""
                  echo "Espa√ßo em disco:"
                  df -h || true
                  echo ""
                  echo "Vari√°veis de ambiente:"
                  env | grep -i python || true

            - name: Gerar relat√≥rio de evid√™ncias
              if: always()
              run: |
                  echo "=========================================="
                  echo "GERANDO RELAT√ìRIO DE EVID√äNCIAS"
                  echo "=========================================="

                  cat > test-results/test-evidence-report.md << 'EOF'
                  # Relat√≥rio de Evid√™ncias - Testes de Aceita√ß√£o

                  **Data de Execu√ß√£o:** $(date)
                  **Commit:** ${{ github.sha }}
                  **Branch:** ${{ github.ref_name }}
                  **Workflow:** ${{ github.workflow }}
                  **Run ID:** ${{ github.run_id }}

                  ## Resumo dos Testes

                  ### Testes Funcionais
                  - **Status:** ${{ steps.functional_tests.outcome }}
                  - **Arquivo:** tests/acceptance/test_fluxo_completo_loja.py

                  ### Testes de Performance
                  - **Status:** ${{ steps.performance_tests.outcome }}
                  - **Arquivo:** tests/acceptance/test_performance.py

                  ## Artefatos Gerados

                  - Resultados dos testes (XML): test-results/
                  - Logs da aplica√ß√£o: test-results/app-failure.log (se houver falha)
                  - M√©tricas de performance: test-results/performance-*.json
                  - Resultados de aceita√ß√£o: test-results/acceptance-test-results.json

                  ## Ambiente de Teste

                  - **Sistema Operacional:** Ubuntu Latest
                  - **Python:** 3.11
                  - **Runner:** GitHub Actions

                  ---

                  *Relat√≥rio gerado automaticamente pelo workflow de Testes de Aceita√ß√£o*
                  EOF

                  cat test-results/test-evidence-report.md

            - name: Upload dos resultados dos testes
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: acceptance-test-results
                  path: |
                      test-results/
                      test-screenshots/
                      test-videos/
                  retention-days: 30

            - name: Upload dos logs da aplica√ß√£o
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: application-logs
                  path: |
                      app.log
                      test-results/app-failure.log
                  retention-days: 30
                  if-no-files-found: ignore

            - name: Publicar resultados dos testes
              if: always()
              uses: EnricoMi/publish-unit-test-result-action@v2
              with:
                  files: |
                      test-results/*.xml
                  check_name: Resultados dos Testes de Aceita√ß√£o
                  comment_title: üìã Resultados dos Testes de Aceita√ß√£o

            - name: Finalizar aplica√ß√£o
              if: always()
              run: |
                  echo "Finalizando aplica√ß√£o..."
                  if [ ! -z "$APP_PID" ]; then
                    kill $APP_PID 2>/dev/null || true
                    echo "Aplica√ß√£o finalizada"
                  fi

            - name: Verificar sucesso dos testes
              if: steps.functional_tests.outcome != 'success' || steps.performance_tests.outcome != 'success'
              run: |
                  echo "=========================================="
                  echo "TESTES DE ACEITA√á√ÉO FALHARAM"
                  echo "=========================================="
                  echo "Testes Funcionais: ${{ steps.functional_tests.outcome }}"
                  echo "Testes de Performance: ${{ steps.performance_tests.outcome }}"
                  exit 1

            - name: Conclus√£o dos testes
              if: success()
              run: |
                  echo "=========================================="
                  echo "‚úì TODOS OS TESTES DE ACEITA√á√ÉO PASSARAM"
                  echo "=========================================="
                  echo "Testes Funcionais: ‚úì Aprovado"
                  echo "Testes de Performance: ‚úì Aprovado"
                  echo "=========================================="
